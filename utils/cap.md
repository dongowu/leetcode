# CAP原理详解

CAP定理（Consistency, Availability, Partition Tolerance）是分布式系统设计中的核心理论，指出分布式系统无法同时满足以下三个特性，只能在三者中选择其二：

## 一、CAP三特性定义
1. **一致性（Consistency）**：所有节点在同一时间看到的相同数据副本，客户端的写操作完成后，后续读操作必须返回最新写入的值（强一致性）或最终一致的值（弱一致性）。
2. **可用性（Availability）**：每个非故障节点都能在合理时间内响应请求，返回有效结果（无错误或超时）。
3. **分区容错性（Partition Tolerance）**：系统在网络分区（部分节点无法通信）时仍能继续提供服务。

## 二、权衡关系
由于网络分区不可避免（P必选），实际设计中需在C和A之间权衡：
- **CP模型（一致性+分区容错）**：优先保证一致性，牺牲部分可用性。当发生网络分区时，系统可能拒绝写请求（如多数派节点不可用时），直到分区恢复。
- **AP模型（可用性+分区容错）**：优先保证可用性，允许数据短暂不一致。当发生网络分区时，各分区独立响应请求，最终通过同步机制恢复一致。

## 三、典型应用场景
### 1. etcd（CP模型）
- 实现方式：通过Raft协议保证强一致性，写操作需多数派节点确认后提交。
- 场景适配：微服务注册中心需确保服务实例信息一致（如电商大促时避免流量错误路由），因此选择CP模型。

### 2. Redis（AP模型）
- 实现方式：主从复制采用异步同步，允许从节点数据短暂落后于主节点。
- 场景适配：缓存系统更关注高可用（避免因主从同步延迟导致服务不可用），因此选择AP模型。

### 3. Eureka（AP模型）
- 实现方式：节点间无强同步机制，允许数据不一致（通过自我保护模式避免误删存活实例）。
- 场景适配：服务发现系统需保证实例注册/心跳响应的高可用，因此选择AP模型。

### 4.CP模型
 > 适用场景 ：对数据一致性要求高，允许短暂不可用（如注册中心、配置中心）。

- etcd ：通过Raft协议实现强一致性，写操作需多数派节点确认后提交。适用于微服务注册中心（避免流量错误路由）。
- ZooKeeper ：基于ZAB协议（类Raft），写操作需多数派确认，用于分布式协调（如分布式锁、命名服务）

### 5.AP模型
 > 适用场景 ：对可用性要求高，允许数据最终一致（如缓存、服务发现）

- Redis ：主从异步复制，允许从节点数据短暂落后。适用于缓存系统（避免因同步延迟导致服务不可用）。
- Eureka ：节点间无强同步机制，通过自我保护模式避免误删实例。适用于服务发现（保证实例注册/心跳的高可用）。
- Cassandra ：多数据中心复制，写操作可选择一致性级别（如单节点确认）。适用于日志存储（允许短暂不一致但需高写入性能）。